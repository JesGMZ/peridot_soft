<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}PERIDOT - Sistema Forense{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- CSS Base -->
  <link rel="stylesheet" href="{{ url_for('static', filename='base.css') }}">
  
  {% block head %}{% endblock %}

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%);
      margin: 0;
      min-height: 100vh;
      overflow-y: auto;
    }

    .app-content {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 2rem;
      margin: 1rem;
    }

    .header {
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.95) 0%, 
        rgba(255, 255, 255, 0.98) 50%, 
        rgba(248, 250, 252, 0.95) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(226, 232, 240, 0.8);
      border-radius: 20px;
      padding: 3rem 2rem;
      text-align: center;
      margin-bottom: 2rem;
      box-shadow: 
        0 20px 50px rgba(0, 0, 0, 0.08),
        0 8px 32px rgba(0, 0, 0, 0.04),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
      position: relative;
      overflow: hidden;
    }

    /* PASO 3: Efecto de brillo sutil */
    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(59, 130, 246, 0.03), 
        transparent);
      animation: headerShimmer 6s infinite;
      z-index: 1;
    }

    @keyframes headerShimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    /* PASO 4: Mejora del texto del t칤tulo */
    .header h1 {
      background: linear-gradient(135deg, 
        #1e40af 0%, 
        #3b82f6 30%, 
        #0ea5e9 60%, 
        #06b6d4 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
      font-size: 2.8rem;
      margin-bottom: 0.5rem;
      text-shadow: none;
      position: relative;
      z-index: 2;
      letter-spacing: -0.02em;
    }

    /* PASO 5: Mejora del subt칤tulo */
      .subtitle {
        color: #64748b;
        font-size: 16px;
        margin: 0;
        font-weight: 500;
        position: relative;
        z-index: 2;
        opacity: 0.9;
      }

    /* PASO 6: Estilo para el bot칩n del micr칩fono */
    .btn-outline-secondary {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #e2e8f0;
      color: #475569;
      border-radius: 12px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      z-index: 2;
      margin-top: 1rem;
    }

    .btn-outline-secondary:hover {
      background: rgba(248, 250, 252, 0.95);
      border-color: #cbd5e1;
      color: #334155;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    /* PASO 7: Efecto hover para todo el header */
    .header:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 25px 60px rgba(0, 0, 0, 0.12),
        0 12px 40px rgba(0, 0, 0, 0.06),
        inset 0 1px 0 rgba(255, 255, 255, 0.95);
      transition: all 0.4s ease;
    }

    .content-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2rem;
      margin-top: 1rem;
    }

    @media (max-width: 768px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
    }

    .stream-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stream-container:hover {
      transform: translateY(-5px);
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
    }

    .card-header {
      background: linear-gradient(135deg, #1e40af, #0ea5e9);
      color: white;
      padding: 1.5rem;
      border: none;
      position: relative;
      overflow: hidden;
    }

    .card-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .card-header h5 {
      margin: 0;
      font-weight: 600;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .video-container {
      position: relative;
      background: linear-gradient(145deg, #f8fafc, #e2e8f0);
      border-radius: 16px;
      overflow: hidden;
      margin: 1.5rem;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .video-container img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 16px;
      transition: transform 0.3s ease;
    }

    .video-container:hover img {
      transform: scale(1.02);
    }

    .controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      padding: 0 1.5rem 1.5rem;
    }

    .btn {
      border-radius: 12px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: linear-gradient(135deg, #1e40af, #0ea5e9);
      box-shadow: 0 4px 15px rgba(30, 64, 175, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(30, 64, 175, 0.6);
    }

    .btn-outline-primary {
      background: transparent;
      border: 2px solid #1e40af;
      color: #1e40af;
    }

    .btn-outline-primary:hover {
      background: linear-gradient(135deg, #1e40af, #0ea5e9);
      border-color: transparent;
      color: white;
      transform: translateY(-2px);
    }

    .btn-success {
      background: linear-gradient(135deg, #059669, #10b981);
      color: white;
      box-shadow: 0 4px 15px rgba(5, 150, 105, 0.4);
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #047857, #059669);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(5, 150, 105, 0.6);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Pantalla de carga */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .loading-overlay.show {
      display: flex;
    }

    .loading-content {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 3rem 2rem;
      text-align: center;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
    }

    .loading-spinner {
      width: 80px;
      height: 80px;
      margin: 0 auto 2rem;
      border: 4px solid rgba(30, 64, 175, 0.2);
      border-top: 4px solid #1e40af;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: #1e40af;
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .loading-subtext {
      color: #64748b;
      font-size: 0.9rem;
    }

    .analysis-section {
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      padding: 1.5rem;
      margin-top: 1rem;
    }

    .image-container {
      background: linear-gradient(145deg, #f8fafc, #e2e8f0);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .image-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, 
        rgba(30, 64, 175, 0.1) 0%, 
        transparent 25%, 
        transparent 75%, 
        rgba(14, 165, 233, 0.1) 100%);
      pointer-events: none;
      z-index: 1;
    }

    .point-overlay {
      pointer-events: auto;
      z-index: 10;
    }

    .point {
      position: absolute;
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      border: 3px solid white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 4px 20px rgba(255, 107, 107, 0.4);
      z-index: 15;
    }

    .point::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      border-radius: 50%;
      animation: pulse 2s infinite;
      z-index: -1;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.5); opacity: 0.3; }
      100% { transform: scale(1); opacity: 1; }
    }

    .point:hover {
      transform: translate(-50%, -50%) scale(1.4);
      box-shadow: 0 8px 30px rgba(255, 107, 107, 0.6);
    }

    .point-label {
      position: absolute;
      top: -50px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      color: white;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
      z-index: 25;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .point-label::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.9);
    }

    .evidence-scroll {
      display: flex;
      flex-direction: row;
      gap: 1rem;
      overflow-x: auto;
      padding: 1rem 0;
      max-height: none;
      scroll-snap-type: x mandatory;
    }

    .evidence-scroll::-webkit-scrollbar {
      height: 8px;
    }

    .evidence-card {
      flex: 0 0 250px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 1rem;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 2px 8px rgba(30, 64, 175, 0.08);
      cursor: pointer;
      scroll-snap-align: start;
      position: relative;
      transition: all 0.3s ease;
      border: 1px solid rgba(226, 232, 240, 0.6);
    }

    .evidence-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(30, 64, 175, 0.15);
      background: rgba(255, 255, 255, 0.98);
      border-color: rgba(59, 130, 246, 0.3);
    }

    .evidence-card.active {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2), 
                  0 8px 25px rgba(30, 64, 175, 0.2);
      background: rgba(59, 130, 246, 0.03);
      transform: translateY(-2px);
    }

    .evidence-card.active::after {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(135deg, #1e40af, #0ea5e9);
      border-radius: 0 2px 2px 0;
    }

    .evidence-number {
      background: linear-gradient(135deg, #1e40af, #0ea5e9);
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
      flex-shrink: 0;
      position: relative;
    }

    .evidence-number::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(135deg, #1e40af, #0ea5e9);
      border-radius: 14px;
      opacity: 0.3;
      z-index: -1;
      animation: pulse-evidence 2s infinite;
    }

    @keyframes pulse-evidence {
      0%, 100% { transform: scale(1); opacity: 0.3; }
      50% { transform: scale(1.1); opacity: 0.1; }
    }

    .evidence-content {
      flex: 1;
      min-width: 0;
    }

    .evidence-content h6 {
      color: #1e40af;
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .evidence-content h6::before {
      content: '游댌';
      font-size: 14px;
    }

    .evidence-content p {
      color: #64748b;
      font-size: 0.875rem;
      line-height: 1.5;
      margin: 0;
      font-weight: 500;
    }

    .evidence-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid rgba(59, 130, 246, 0.1);
    }

    .evidence-status {
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      background: rgba(34, 197, 94, 0.1);
      color: #16a34a;
      font-weight: 600;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .evidence-timestamp {
      font-size: 0.75rem;
      color: #94a3b8;
      font-weight: 500;
    }

    /* Secci칩n de guardado */
    .save-analysis-section {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 1.5rem;
      margin-top: 1rem;
    }

    .save-analysis-section h6 {
      color: white;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .form-control-modern {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .form-control-modern:focus {
      background: rgba(255, 255, 255, 0.95);
      border-color: #1e40af;
      box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.2);
      outline: none;
    }

    .chat-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
      height: fit-content;
      overflow: hidden;
    }

    .chat-input-section {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.05);
    }

    .input-group-modern {
      display: flex;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 25px;
      overflow: hidden;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
    }

    .input-group-modern:focus-within {
      border-color: #1e40af;
      box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.2);
      transform: scale(1.02);
    }

    .form-control-modern {
      border: none;
      outline: none;
      padding: 14px 18px;
      font-size: 14px;
      flex: 1;
      background: transparent;
      font-weight: 500;
    }

    .btn-send {
      background: linear-gradient(135deg, #1e40af, #0ea5e9);
      color: white;
      border: none;
      padding: 14px 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-send::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .btn-send:hover::before {
      left: 100%;
    }

    .btn-send:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(30, 64, 175, 0.4);
    }

    .chat-messages {
      max-height: 450px;
      overflow-y: auto;
      padding: 1rem;
    }

    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #1e40af, #0ea5e9);
      border-radius: 10px;
    }

    .message {
      margin-bottom: 1.5rem;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-bubble {
      padding: 14px 18px;
      border-radius: 20px;
      max-width: 85%;
      word-wrap: break-word;
      position: relative;
      font-weight: 500;
      line-height: 1.5;
    }

    .user-message .message-bubble {
      background: linear-gradient(135deg, #1e40af, #0ea5e9);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 8px;
      box-shadow: 0 4px 15px rgba(30, 64, 175, 0.3);
    }

    .bot-message .message-bubble {
      background: rgba(248, 249, 250, 0.95);
      backdrop-filter: blur(10px);
      color: #1f2937;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-bottom-left-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .message-time {
      font-size: 11px;
      color: #6b7280;
      margin-top: 6px;
      font-weight: 500;
    }

    .loading {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .loading-dots {
      display: flex;
      gap: 6px;
    }

    .loading-dot {
      width: 8px;
      height: 8px;
      background: linear-gradient(135deg, #1e40af, #0ea5e9);
      border-radius: 50%;
      animation: loadingDot 1.4s infinite ease-in-out;
    }

    .loading-dot:nth-child(1) { animation-delay: 0s; }
    .loading-dot:nth-child(2) { animation-delay: 0.2s; }
    .loading-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes loadingDot {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1.3); opacity: 1; }
    }

    .subtitle {
      color: #475569;
      font-size: 16px;
      margin: 0;
      font-weight: 500;
      position: relative;
      z-index: 2;
      opacity: 0.9;
    }

    .analysis-section h6 {
      color: #1e40af;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .stream-container, .chat-container {
      animation: fadeInUp 0.6s ease;
    }

    .modal-backdrop {
      z-index: 1040;
    }
    
    .modal {
      z-index: 1050;
    }

    .modal.show {
      display: block;
      z-index: 1060;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

      .text-gradient {
    background: linear-gradient(90deg, #007bff, #00b894);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    }

  /* Efecto de foco en inputs */
    .focus-ring:focus {
      border-color: #00b894 !important;
      box-shadow: 0 0 8px rgba(0, 184, 148, 0.4);
    }

    /* Bot칩n flotante de voz */
.floating-voice-btn {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, #1e40af, #0ea5e9);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 20px;
  cursor: pointer;
  box-shadow: 0 8px 25px rgba(30, 64, 175, 0.4);
  transition: all 0.3s ease;
  z-index: 1000;
  border: 3px solid rgba(255, 255, 255, 0.2);
}

.floating-voice-btn:hover {
  transform: translateY(-5px) scale(1.1);
  box-shadow: 0 15px 35px rgba(30, 64, 175, 0.6);
  background: linear-gradient(135deg, #0ea5e9, #06b6d4);
}

.floating-voice-btn:active {
  transform: translateY(-3px) scale(1.05);
  background: linear-gradient(135deg, #1e40af, #1d4ed8);
}

/* Animaci칩n de pulso cuando est치 activo */
.floating-voice-btn.listening {
  animation: voicePulse 1s infinite;
  background: linear-gradient(135deg, #dc2626, #ef4444);
}

@keyframes voicePulse {
  0%, 100% { 
    transform: translateY(-5px) scale(1.1); 
    box-shadow: 0 15px 35px rgba(220, 38, 38, 0.6);
  }
  50% { 
    transform: translateY(-5px) scale(1.2); 
    box-shadow: 0 20px 40px rgba(220, 38, 38, 0.8);
  }
}
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Header / Navbar -->
    <header class="app-header d-flex justify-content-between align-items-center px-3">
      <a href="{{ url_for('main.index') }}" class="app-brand"><i class="fas fa-gem me-2"></i>PERIDOT</a>
      
      <div class="user-info dropdown">
        <i class="fas fa-bell notification-icon me-3"></i>

        <a class="d-flex align-items-center text-decoration-none dropdown-toggle" href="#" role="button" id="userMenuLink" data-bs-toggle="dropdown" aria-expanded="false">
          <div class="user-avatar me-2"><i class="fas fa-user"></i></div>
          <span class="user-name">
            {% if current_user.is_authenticated %}
              {{ current_user.nombre_completo }}
            {% else %}
              Usuario
            {% endif %}
          </span>
        </a>

        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuLink">
          {% if current_user.is_authenticated %}
            <li><a class="dropdown-item" href="{{ url_for('auth.logout') }}">
              <i class="fas fa-sign-out-alt me-2"></i>Cerrar sesi칩n
            </a></li>
          {% else %}
            <li><a class="dropdown-item" href="{{ url_for('auth.login') }}">
              <i class="fas fa-sign-in-alt me-2"></i>Iniciar sesi칩n
            </a></li>
          {% endif %}
        </ul>
      </div>
    </header>

    <main class="app-main">
      <!-- Sidebar -->
      <aside class="app-sidebar">
        <div class="sidebar-content">
          <h2 class="sidebar-title">Panel de Control</h2>
          <nav>
            <ul class="sidebar-nav">
              <li class="sidebar-nav-item">
                <a href="{{ url_for('main.dashboard') }}" class="sidebar-nav-link">
                  <i class="fas fa-home sidebar-nav-icon"></i>
                  Dashboard
                </a>
              </li>

              <li class="sidebar-nav-item">
                <a href="{{ url_for('main.chat_interface') }}" class="sidebar-nav-link active">
                  <i class="fas fa-search sidebar-nav-icon"></i>
                  An치lisis Preliminar
                </a>
              </li>
              
              <li class="sidebar-nav-item">
                <a href="{{ url_for('main.registros') }}" class="sidebar-nav-link">
                  <i class="fas fa-box-archive sidebar-nav-icon"></i>
                  Gesti칩n de Evidencias
                </a>
              </li>
              
              <li class="sidebar-nav-item">
                <a href="#" class="sidebar-nav-link">
                  <i class="fas fa-file-alt sidebar-nav-icon"></i>
                  Informes
                </a>
              </li>
              
              <li class="sidebar-nav-item">
                <a href="#" class="sidebar-nav-link">
                  <i class="fas fa-cogs sidebar-nav-icon"></i>
                  Configuraci칩n
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </aside>

      <!-- Content -->
      <div class="app-content">
        <!-- Contenido del Sistema Forense -->
        <div class="header mb-4">
          <h1 class="h3 mb-2">
            <i class="fas fa-microscope me-2"></i>Escaneo preliminar
          </h1>
          <p class="subtitle">Sistema inteligente de an치lisis forense con detecci칩n autom치tica de evidencias</p>
        </div>

        <div class="content-grid">
          <!-- Panel de an치lisis -->
          <div class="card stream-container mb-4">
            <div class="card-header">
              <h5><i class="fas fa-video"></i> Centro de An치lisis Visual</h5>
            </div>
            <div class="card-body stream-view">
              <!-- Video o imagen capturada -->
              <div class="video-container mb-3">
                {% if img_data %}
                  <img id="analyzedImage" class="img-fluid" src="data:image/png;base64,{{ img_data }}" alt="Imagen analizada">
                  <div id="pointOverlay" class="point-overlay position-absolute top-0 start-0">
                    {% if points_list %}
                      {% for punto in points_list %}
                        {% if punto.point %}
                          <div class="point"
                              style="top: {{ punto.point[0]/1000*100 }}%; left: {{ punto.point[1]/1000*100 }}%;"
                              data-label="{{ punto.label }}">
                          </div>
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  </div>
                {% else %}
                  <img src="{{ url_for('main.stream') }}" alt="C치mara en vivo" id="liveStream">
                {% endif %}
              </div>

              <!-- Controles -->
              <div class="controls mb-3">
                <form action="{{ url_for('main.capturar') }}">
                  <button class="btn btn-primary me-2" type="submit">
                    <i class="fas fa-camera"></i> Capturar Imagen
                  </button>
                </form>

                {% if img_data %}
                <button class="btn btn-outline-primary me-2" type="button" onclick="analyzeImage()" id="analyzeBtn">
                  <i class="fas fa-search"></i> Analizar Imagen
                </button>

                <form action="{{ url_for('main.reset') }}" method="post" class="d-inline">
                  <button class="btn btn-danger" type="submit">
                    <i class="fas fa-rotate-left"></i> Reiniciar
                  </button>
                </form>
                {% endif %}
              </div>

              <!-- Panel de Evidencias -->
              {% if img_data and points_list %}
                <div class="evidence-scroll">
                  {% for punto in points_list %}
                    {% if punto.point %}
                      <div class="evidence-card card p-2 mb-2" data-point-id="{{ loop.index }}">
                        <div class="evidence-card-body">
                          <div class="evidence-number fw-bold">#{{ loop.index }}</div>
                          <h6 class="text-primary mb-1">Evidencia {{ loop.index }}</h6>
                          <p class="text-muted small mb-2">{{ punto.label }}</p>
                          
                          <button type="button" class="btn btn-sm btn-outline-primary" 
                                  data-bs-toggle="modal" 
                                  data-bs-target="#modalEvidencia{{ loop.index }}">
                            Ver detalles
                          </button>
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>

<!-- Secci칩n de Guardado de An치lisis -->
<div class="save-analysis-section bg-white p-4 rounded-4 shadow-lg border border-2 border-light">
  <h5 class="mb-4 fw-bold text-gradient">
    <i class="fas fa-save me-2"></i> Datos del an치lisis preliminar
  </h5>

  <form id="saveAnalysisForm">
    <div class="row g-4">
      <!-- Descripci칩n -->
      <div class="col-md-6">
        <label for="descripcion" class="form-label fw-semibold text-muted">游닇 Descripci칩n del Caso</label>
        <textarea 
          class="form-control shadow-sm rounded-3 focus-ring" 
          id="descripcion" 
          name="descripcion" 
          rows="4"
          placeholder="Redacta una breve descripci칩n del caso investigado..."></textarea>
      </div>

      <!-- Ubicaci칩n y N칰mero de Caso -->
      <div class="col-md-6">
        <label for="ubicacion" class="form-label fw-semibold text-muted">游늸 Ubicaci칩n de la Escena</label>
        <input 
          type="text" 
          class="form-control shadow-sm rounded-3 mb-3 focus-ring" 
          id="ubicacion" 
          name="ubicacion" 
          placeholder="Ejemplo: Av. Principal 123, Lima - Per칰">

        <label for="caso" class="form-label fw-semibold text-muted">游댔 N칰mero de Caso</label>
        <input 
          type="text" 
          class="form-control shadow-sm rounded-3 focus-ring" 
          id="caso" 
          name="caso" 
          placeholder="Ejemplo: CASE-2025-001">
      </div>
    </div>

    <!-- Bot칩n Guardar -->
    <div class="text-center mt-4">
      <button type="button" class="btn btn-success btn-lg px-5 py-2 shadow-sm rounded-pill" onclick="saveAnalysis()">
        <i class="fas fa-database me-2"></i> Guardar an치lisis
      </button>
    </div>
  </form>
</div>


              {% endif %}

            </div>
          </div>

          <!-- Panel de Chat -->
          <div class="card chat-container">
            <div class="card-header">
              <h5><i class="fas fa-robot"></i> Asistente Forense IA</h5>
            </div>
            
            <div class="chat-input-section">
              <div class="input-group-modern">
                <input 
                  type="text" 
                  id="chatInput" 
                  class="form-control-modern" 
                  placeholder="Pregunta sobre la evidencia..."
                  autocomplete="off"
                >
                <button class="btn-send" onclick="sendMessage()">
                  <i class="fas fa-paper-plane"></i>
                </button>
              </div>
            </div>

            <div id="chatMessages" class="chat-messages">
              <div class="message bot-message">
                <div class="message-bubble">
                  춰Hola! Soy tu asistente forense IA. Puedo ayudarte a analizar evidencias, identificar objetos y responder preguntas sobre la escena del crimen.
                </div>
                <div class="message-time">Sistema iniciado</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Pantalla de carga -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">Analizando imagen...</div>
      <div class="loading-subtext">El sistema IA est치 procesando la imagen y detectando evidencias. Este proceso puede tomar unos momentos.</div>
    </div>
  </div>

<!-- 츼rea para los modales -->
{% if img_data and points_list %}
  {% for punto in points_list %}
    {% if punto.point and punto.analisis %}
      <!-- Modal (uno por cada evidencia) -->
      <div class="modal fade" id="modalEvidencia{{ loop.index }}" tabindex="-1" aria-labelledby="modalLabel{{ loop.index }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="modalLabel{{ loop.index }}">
                <i class="fas fa-microscope me-2"></i>Evidencia {{ loop.index }}: {{ punto.label }}
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <h6 class="text-primary">1. Ubicaci칩n y posici칩n</h6>
                    <p class="border p-2 rounded">{{ punto.analisis.ubicacion or "No especificado" }}</p>
                  </div>
                  
                  <div class="mb-3">
                    <h6 class="text-primary">2. Naturaleza del objeto</h6>
                    <p class="border p-2 rounded">{{ punto.analisis.naturaleza or "No especificado" }}</p>
                  </div>
                  
                  <div class="mb-3">
                    <h6 class="text-primary">3. Condici칩n f칤sica</h6>
                    <p class="border p-2 rounded">{{ punto.analisis.condicion or "No especificado" }}</p>
                  </div>
                  
                  <div class="mb-3">
                    <h6 class="text-primary">4. Indicios adheridos</h6>
                    <p class="border p-2 rounded">{{ punto.analisis.indicios or "No se observan indicios" }}</p>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="mb-3">
                    <h6 class="text-primary">5. Pertinencia con el caso</h6>
                    <p class="border p-2 rounded">{{ punto.analisis.pertinencia or "Por determinar" }}</p>
                  </div>
                  
                  <div class="mb-3">
                    <h6 class="text-primary">6. Valor probatorio</h6>
                    <p class="border p-2 rounded">{{ punto.analisis.valor_probatorio or "Por evaluar" }}</p>
                  </div>
                  
                  <div class="mb-3">
                    <h6 class="text-primary">7. Observaciones</h6>
                    <p class="border p-2 rounded">{{ punto.analisis.observaciones or "Sin observaciones adicionales" }}</p>
                  </div>
                  
                  <div class="mb-3">
                    <h6 class="text-primary">Estado de Verificaci칩n</h6>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="verificado{{ loop.index }}">
                      <label class="form-check-label" for="verificado{{ loop.index }}">
                        Marcar como verificado
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
              <button type="button" class="btn btn-primary">Guardar An치lisis</button>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  {% endfor %}
{% endif %}

<!-- Bot칩n flotante para hablar -->
<div class="floating-voice-btn" onclick="startListening()" title="Activar comando de voz">
  <i class="fas fa-microphone"></i>
</div>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Scripts espec칤ficos del an치lisis forense -->
  <script>
    // Datos de puntos de evidencia
    const pointsData = {{ points_json|safe }} || [];
    const analyzedImage = document.getElementById("analyzedImage");
    const pointOverlay = document.getElementById("pointOverlay");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const loadingOverlay = document.getElementById("loadingOverlay");

    // Funci칩n para mostrar/ocultar pantalla de carga
    function showLoading() {
      loadingOverlay.classList.add('show');
    }

    function hideLoading() {
      loadingOverlay.classList.remove('show');
    }

    // Funci칩n para analizar imagen con pantalla de carga
    async function analyzeImage() {
      const analyzeBtn = document.getElementById('analyzeBtn');
      
      // Deshabilitar bot칩n y mostrar carga
      analyzeBtn.disabled = true;
      analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analizando...';
      showLoading();

      try {
        // Crear formulario y enviarlo
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("main.analizar") }}';
        document.body.appendChild(form);
        form.submit();
      } catch (error) {
        console.error('Error al analizar:', error);
        hideLoading();
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = '<i class="fas fa-search"></i> Analizar Imagen';
        alert('Error al analizar la imagen. Int칠ntalo de nuevo.');
      }
    }

    // Funci칩n para guardar an치lisis
    async function saveAnalysis() {
      const form = document.getElementById('saveAnalysisForm');
      const formData = new FormData(form);

      try {
        showLoading();
        
        const response = await fetch('{{ url_for("main.guardar_analisis") }}', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          hideLoading();
          
          // Mostrar mensaje de 칠xito
          const successAlert = document.createElement('div');
          successAlert.className = 'alert alert-success alert-dismissible fade show position-fixed';
          successAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
          successAlert.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            <strong>춰An치lisis guardado exitosamente!</strong><br>
            ID del an치lisis: #${result.analisis_id}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          `;
          document.body.appendChild(successAlert);

          // Auto-cerrar despu칠s de 5 segundos
          setTimeout(() => {
            if (successAlert.parentNode) {
              successAlert.remove();
            }
          }, 5000);

          // Opcional: redirigir al dashboard o limpiar formulario
          form.reset();
          
        } else {
          throw new Error(result.error || 'Error desconocido');
        }

      } catch (error) {
        hideLoading();
        console.error('Error al guardar:', error);
        
        // Mostrar mensaje de error
        const errorAlert = document.createElement('div');
        errorAlert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        errorAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        errorAlert.innerHTML = `
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong>Error al guardar:</strong><br>
          ${error.message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(errorAlert);

        setTimeout(() => {
          if (errorAlert.parentNode) {
            errorAlert.remove();
          }
        }, 5000);
      }
    }

    function initializePoints() {
      if (analyzedImage && pointsData && pointsData.length > 0) {
        if (analyzedImage.complete) {
          updatePointPositions();
        } else {
          analyzedImage.onload = () => { updatePointPositions(); };
        }
        window.addEventListener('resize', debounce(updatePointPositions, 250));
      }
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => { clearTimeout(timeout); func(...args); };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function updatePointPositions() {
      if (!analyzedImage || !pointOverlay || !pointsData || pointsData.length === 0) return;
      const width = analyzedImage.clientWidth;
      const height = analyzedImage.clientHeight;
      if (width === 0 || height === 0) return;
      pointOverlay.style.width = width + "px";
      pointOverlay.style.height = height + "px";
      pointOverlay.innerHTML = "";
      pointsData.forEach((pointData, index) => {
        if (!pointData || !pointData.point) return;
        const [y, x] = pointData.point;
        const pointX = (x / 1000) * width;
        const pointY = (y / 1000) * height;
        const point = document.createElement("div");
        point.className = "point";
        point.id = `point-${index + 1}`;
        point.style.left = pointX + "px";
        point.style.top = pointY + "px";
        const label = document.createElement("div");
        label.className = "point-label";
        label.textContent = `${index + 1}. ${pointData.label || 'Evidencia'}`;
        const labelPosition = calculateLabelPosition(pointX, pointY, width, height);
        if (labelPosition) label.classList.add(labelPosition);
        point.appendChild(label);
        pointOverlay.appendChild(point);
        point.addEventListener('mouseenter', () => { label.style.opacity = '1'; });
        point.addEventListener('mouseleave', () => { label.style.opacity = '0'; });
        point.addEventListener('click', () => { highlightPoint(index + 1); });
      });
      console.log(`Puntos creados: ${pointsData.length}`);
    }

    function calculateLabelPosition(pointX, pointY, containerWidth, containerHeight) {
      const margin = 20, labelWidth = 200, labelHeight = 40;
      if (pointX + labelWidth + margin > containerWidth) return 'position-left';
      if (pointY - labelHeight - margin < 0) return 'position-bottom';
      if (pointY + labelHeight + margin > containerHeight) return 'position-top';
      return '';
    }

    function highlightPoint(pointId) {
      document.querySelectorAll(".point").forEach(p => {
        p.style.transform = "translate(-50%, -50%)";
        p.style.boxShadow = "0 4px 12px rgba(239, 68, 68, 0.4)";
        const label = p.querySelector(".point-label");
        if (label) label.style.opacity = "0";
      });
      document.querySelectorAll(".evidence-card").forEach(c => c.classList.remove("active"));
      const targetPoint = document.getElementById(`point-${pointId}`);
      const targetCard = document.querySelector(`[data-point-id="${pointId}"]`);
      if (targetPoint) {
        targetPoint.style.transform = "translate(-50%, -50%) scale(1.5)";
        targetPoint.style.boxShadow = "0 8px 25px rgba(239, 68, 68, 0.8)";
        const label = targetPoint.querySelector(".point-label");
        if (label) {
          label.style.opacity = "1";
          setTimeout(() => { if (label) label.style.opacity = "0"; }, 3000);
        }
      }
      if (targetCard) {
        targetCard.classList.add("active");
        targetCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      initializePoints();
      document.querySelectorAll(".evidence-card").forEach(card => {
        card.addEventListener("click", () => {
          const id = parseInt(card.getAttribute("data-point-id"));
          if (id) {
            highlightPoint(id);
            const analyzedImage = document.getElementById("analyzedImage");
            if (analyzedImage) analyzedImage.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        });
      });
    });

    let isLoading = false;

    function addMessage(content, isUser = false) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
      const bubble = document.createElement("div");
      bubble.className = "message-bubble";
      bubble.innerHTML = content;
      const time = document.createElement("div");
      time.className = "message-time";
      time.textContent = new Date().toLocaleTimeString();
      messageDiv.appendChild(bubble);
      messageDiv.appendChild(time);
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addLoadingMessage() {
      const loadingDiv = document.createElement("div");
      loadingDiv.className = "message bot-message";
      loadingDiv.id = "loading-message";
      const bubble = document.createElement("div");
      bubble.className = "message-bubble";
      bubble.innerHTML = `
        <div class="loading">
          <span>Analizando</span>
          <div class="loading-dots">
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
            <div class="loading-dot"></div>
          </div>
        </div>`;
      loadingDiv.appendChild(bubble);
      chatMessages.appendChild(loadingDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      return loadingDiv;
    }

    async function sendMessage(inputText=null) {
        const input = inputText || document.getElementById("chatInput").value;
        if (!input.trim()) return;

        // Mostrar en chat
        const chatMessages = document.getElementById("chatMessages");
        chatMessages.innerHTML += `
          <div class="message user-message">
            <div class="message-bubble">${input}</div>
            <div class="message-time">T칰</div>
          </div>
        `;

        // Enviar al backend
        const response = await fetch("/chatbot", {
          method: "POST",
          headers: {"Content-Type": "application/x-www-form-urlencoded"},
          body: `pregunta=${encodeURIComponent(input)}`
        });
        const data = await response.json();

        // Mostrar respuesta
        chatMessages.innerHTML += `
          <div class="message bot-message">
            <div class="message-bubble">${data.respuesta}</div>
            <div class="message-time">IA</div>
          </div>
        `;

        // Leer la respuesta en voz alta
        speak(data.respuesta);

        document.getElementById("chatInput").value = "";
      }

    if (chatInput) {
      chatInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });
      chatInput.addEventListener("input", function() {
        this.style.height = "auto";
        this.style.height = Math.min(this.scrollHeight, 120) + "px";
      });
    }

    const liveStream = document.getElementById("liveStream");
    if (liveStream) {
      liveStream.addEventListener("load", () => { liveStream.style.opacity = "1"; });
    }

    window.testPoints = function() {
      console.log("Points data:", pointsData);
      console.log("Analyzed image:", analyzedImage);
      console.log("Point overlay:", pointOverlay);
      updatePointPositions();
    };
  </script>
  <script>
  let recognition;
  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = "es-ES";
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onresult = function(event) {
      const command = event.results[0][0].transcript.toLowerCase();
      console.log("Comando detectado:", command);
      processVoiceCommand(command);
    };

    recognition.onerror = function(event) {
      console.error("Error en reconocimiento:", event.error);
    };
  }

  function startListening() {
    if (recognition) recognition.start();
  }

  // Procesa comandos de voz y ejecuta rutas
  function processVoiceCommand(command) {
    if (command.includes("capturar")) {
      window.location.href = "/capturar";
    } else if (command.includes("analizar")) {
      fetch("/analizar", {method:"POST"}).then(()=>location.reload());
    } else if (command.includes("registros")) {
      window.location.href = "/registros";
    } else if (command.includes("dashboard")) {
      window.location.href = "/dashboard";
    } else {
      // Si no es un comando, se env칤a al chatbot como pregunta
      sendMessage(command);
    }
  }
</script>
<script>
  function speak(text) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "es-ES";
    window.speechSynthesis.speak(utterance);
  }
</script>



</body>
</html>